#!/bin/sh

#------------------------------------------#
# Add App Service DB                       #
#------------------------------------------#

# Macro
PATH=/bin:/usr/bin:/sbin:/usr/sbin

# Create DB Path
mkdir -p -Z User::Home -m 755 /opt/dbspace/user
export `tzplatform-get --user $2 TZ_USER_NAME`
mkdir -p -Z User::Home -m 770 /opt/dbspace/user/$2
chown $TZ_USER_NAME:system_share /opt/dbspace/user/$2

# Create DB
sqlite3 /opt/dbspace/user/$2/.appsvc.db << EOF
PRAGMA journal_mode = PERSIST;

CREATE TABLE IF NOT EXISTS appsvc (
	operation TEXT,
	mime_type TEXT DEFAULT 'NULL',
	uri TEXT DEFAULT 'NULL',
	pkg_name TEXT,
	PRIMARY KEY (operation,mime_type,uri)
);

CREATE TABLE IF NOT EXISTS alias_info (
	alias_appid TEXT NOT NULL,
	appid TEXT NOT NULL,
	enable TEXT NOT NULL DEFAULT 'true',
	PRIMARY KEY (alias_appid)
);

CREATE TABLE IF NOT EXISTS alias_info_for_uid (
	appid TEXT NOT NULL,
	uid INTEGER NOT NULL,
	is_enabled TEXT NOT NULL DEFAULT 'false',
	PRIMARY KEY (appid, uid)
	FOREIGN KEY (appid)
	REFERENCES alias_info(appid)
	ON DELETE CASCADE
);

CREATE TRIGGER IF NOT EXISTS update_alias_info_for_uid
	AFTER UPDATE ON alias_info_for_uid
	BEGIN
		DELETE FROM alias_info_for_uid
		WHERE is_enabled='true';
	END;

CREATE TABLE IF NOT EXISTS allowed_info (
	appid TEXT NOT NULL,
	allowed_appid TEXT NOT NULL,
	PRIMARY KEY (appid, allowed_appid)
);

EOF

# Adjust Permission
chmod 664 /opt/dbspace/user/$2/.appsvc.db
chmod 664 /opt/dbspace/user/$2/.appsvc.db-journal

chown $TZ_USER_NAME:system_share /opt/dbspace/user/$2/.appsvc.db
chown $TZ_USER_NAME:system_share /opt/dbspace/user/$2/.appsvc.db-journal

chsmack -a User::Home /opt/dbspace/user/$2/.appsvc.db
chsmack -a User::Home /opt/dbspace/user/$2/.appsvc.db-journal

